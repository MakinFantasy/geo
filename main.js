(()=>{"use strict";const e=document.querySelector(".chat-widget"),t=e.querySelector(".chat-widget__messages-container"),s=e.querySelector(".chat-widget__messages"),a=e.querySelector(".chat-widget__input"),o=new class{constructor(e,t,s){this.chatInput=e,this.messages=t,this.messagesContainer=s}static getTime(){const e=new Date;return new Intl.DateTimeFormat("ru-RU",{dateStyle:"short",timeStyle:"short"}).format(e).replace(/\d{2}(\d{2}),/,"$1")}addMessage(e){const t=this.constructor.getTime();this.messages.insertAdjacentHTML("beforeend",`\n          <div class="message">\n            <div class="message__header">${t}</div>\n            <div class="message__text">${this.chatInput.value}</div>\n            <div class="message__coordinates">[${e.lat}, ${e.lon}] <a href="http://www.google.com/maps/place/${e.lat},${e.lon}" target="_blank">&#128065;</a></div>\n          </div>\n        `),this.messagesContainer.scrollTo(0,this.messagesContainer.scrollHeight),this.chatInput.value="",this.chatInput.dataset.geoResponse="",this.chatInput.focus()}}(a,s,t),n=document.querySelector(".modal"),i=n.querySelector(".modal__header"),r=n.querySelector(".modal__message"),l=n.querySelector(".modal__form"),d=n.querySelector(".modal-form__input"),c=n.querySelector(".modal-form__button-cancel"),h=new class{constructor(e,t,s,a,o,n,i,r){this.modalWindow=e,this.modalHeader=t,this.modalMessage=s,this.modalForm=a,this.modalFormInput=o,this.modalCancelButton=n,this.chatInput=i,this.chatMessagesMaker=r}setContent(e){this.modalHeader.textContent=e.header,this.modalMessage.textContent=e.message}toggle(){this.modalWindow.classList.toggle("active")}getCoords(){const e=this.modalFormInput.value.replace(/^\[/,"").replace(/\]$/,"").replace(/, /,","),[t,s]=e.split(",");return{lat:+t,lon:+s}}checkModalFormInput(){return/^\[?[−-]?([0-9]|[1-8][0-9])(\.\d{1,5})?,\s?[−-]?([0-9]|[1-9][0-9]|[1][0-7][0-9])(\.\d{1,5})?\]?$/.test(this.modalFormInput.value)}static manageValidity(e,t){e?t.setCustomValidity(""):t.setCustomValidity("Координаты указаны неверно")}assignInputCheckerHandler(){this.modalFormInput.addEventListener("change",(()=>this.constructor.manageValidity(this.checkModalFormInput(),this.modalFormInput))),this.modalFormInput.addEventListener("input",(()=>this.constructor.manageValidity(this.checkModalFormInput(),this.modalFormInput)))}assignSubmitHandler(){this.modalForm.addEventListener("submit",(e=>{e.preventDefault(),this.checkModalFormInput()?(this.toggle(),this.chatMessagesMaker.addMessage(this.getCoords()),this.modalHeader.textContent="",this.modalMessage.textContent="",this.modalForm.reset()):this.modalFormInput.setCustomValidity("Координаты указаны неверно")}))}assignCancelHandler(){this.modalCancelButton.onclick=()=>{this.chatInput.focus(),this.chatInput.selectionStart=this.chatInput.value.length,this.toggle(),this.modalHeader.textContent="",this.modalMessage.textContent="",this.modalForm.reset()}}}(n,i,r,l,d,c,a,o);h.assignInputCheckerHandler(),h.assignSubmitHandler(),h.assignCancelHandler();const u=new class{constructor(e){this.chatInput=e}setLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>this.handleSuccess(e)),(e=>this.handleFailure(e))):this.chatInput.dataset.geoResponse=JSON.stringify({header:"Ваш браузер не поддерживает геолокацию",message:"Смените браузер, либо введите местоположение вручную"})}handleSuccess(e){this.chatInput.dataset.geoResponse=JSON.stringify({success:!0,lat:e.coords.latitude,lon:e.coords.longitude})}handleFailure(e){const t={header:"",message:""};switch(e.code){case e.PERMISSION_DENIED:t.header="Настройками текущего браузера запрещен запрос геолокации",t.message="Измените настройки конфиденциальности, либо введите местоположение вручную";break;case e.POSITION_UNAVAILABLE:t.header="Информация о вашем местоположении недоступна",t.message="Введите местоположение вручную";break;case e.TIMEOUT:t.header="Истекло время ожидания запроса вашего местоположения",t.message='Нажмите "Отмена" и попробуйте ещё раз, либо введите местоположение вручную';break;default:t.header="Произошла неизвестная ошибка",t.message='Нажмите "Отмена" и попробуйте ещё раз, либо введите местоположение вручную'}this.chatInput.dataset.geoResponse=JSON.stringify(t)}}(a);a.addEventListener("keyup",(e=>function(e,t,s,a,o){if("Enter"===e.key){const{value:e}=t;if(!e||!e.trim())return void t.setAttribute("value","");a.setLocation(),t.setAttribute("disabled",""),t.setAttribute("disabled",""),new Promise((e=>{setTimeout((()=>{t.dataset.geoResponse&&e()}),100)})).then((()=>{const e=JSON.parse(t.dataset.geoResponse);t.removeAttribute("disabled"),e.success?s.addMessage(e):(o.setContent(e),o.toggle())}))}}(e,a,o,u,h))),a.value="Хорошего дня! &#128512;",o.addMessage({lat:51.50851,lon:-.12572}),a.focus()})();